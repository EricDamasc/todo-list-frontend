<div class="spinner-overlay" *ngIf="carregando">
  <mat-spinner></mat-spinner>
</div>
<div class="header">
  <div class="menu">
    <button mat-button [matMenuTriggerFor]="menu" #menuTrigger class="menu-button">
      <mat-icon>menu</mat-icon>
      Menu
    </button>
    <mat-menu #menu="matMenu" class="custom-menu">
      <button mat-menu-item (click)="openCreateTaskDialog()">
        <mat-icon>add</mat-icon>
        Criar Tarefa
      </button>
      <button mat-menu-item>
        <mat-icon>settings</mat-icon>
        Configurações
      </button>
      <button mat-menu-item>
        <mat-icon>help</mat-icon>
        Ajuda
      </button>
      <button mat-menu-item (click)="openAboutDialog()">
        <mat-icon>info</mat-icon>
        Sobre
      </button>
    </mat-menu>
    
    <ng-template #aboutDialog>
      <h2 mat-dialog-title>
        <mat-icon>info</mat-icon>
        Sobre
      </h2>
      <mat-dialog-content>
        <p><strong>Versão:</strong> 1.0.0</p>
        <p><strong>Motivo da Criação:</strong> Este aplicativo foi criado como parte do Trabalho de Conclusão de Curso (TCC) do curso de Desenvolvimento Web Full Stack da PUC-RS. O objetivo é ajudar na organização e gerenciamento de tarefas.</p>
        <p><strong>Criado por:</strong></p>
        <div class="social-icons">
          <a href="https://www.linkedin.com/in/eric-damascena/" target="_blank">
            <img src="assets/ico/linkedinSocialMedia.ico" alt="LinkedIn" class="social-icon">
          </a>
          <a href="https://www.instagram.com/ericdamasc" target="_blank">
            <img src="assets/ico/instagramSocialMedia.ico" alt="Instagram" class="social-icon">
          </a>
        </div>
      </mat-dialog-content>
      <mat-dialog-actions align="end">
        <button mat-button (click)="closeAboutDialog()">Fechar</button>
      </mat-dialog-actions>
    </ng-template>
  </div>
  <div class="title">
    <h1 class="title-text">Minhas Tarefas</h1>
    <mat-icon class="title-icon">assignment</mat-icon>
  </div>
  <div class="user-info">
    <mat-icon>person</mat-icon>
    <span>{{ userEmail }}</span>
    <button mat-button (click)="logout()" class="logout-button">
      <mat-icon>logout</mat-icon>
      Sair
    </button>
  </div>
</div>
<div class="filters">
  <mat-form-field appearance="fill">
    <mat-label>Filtrar por Título</mat-label>
    <input matInput [(ngModel)]="searchText" (input)="applyFilters()">
  </mat-form-field>

  <mat-form-field appearance="fill">
    <mat-label>Filtrar por Prioridade</mat-label>
    <mat-select [(ngModel)]="selectedPriority" (selectionChange)="applyFilters()">
      <mat-option value="">Todas</mat-option>
      <mat-option value="alta">Alta</mat-option>
      <mat-option value="média">Média</mat-option>
      <mat-option value="baixa">Baixa</mat-option>
    </mat-select>
  </mat-form-field>
</div>

<!-- Legendas de Cores -->
<h3 style="text-align: center; font-weight: bold; font-size: 1.2em; margin-bottom: 10px;">Prioridades das Tarefas</h3>
<div class="legend-container">
  <div class="legend-item">
    <span class="legend-color baixa"></span>
    <span>Baixa</span>
  </div>
  <div class="legend-item">
    <span class="legend-color media"></span>
    <span>Média</span>
  </div>
  <div class="legend-item">
    <span class="legend-color alta"></span>
    <span>Alta</span>
  </div>
</div>

<div class="tasks-container">
  <mat-card *ngFor="let task of filteredTasks" class="task-card" [ngClass]="getPriorityClass(task.priority)">
    <mat-card-header>
      <div class="task-header">
        <mat-icon *ngIf="taskChanged[task.task_id]" mat-button (click)="updateTask(task)">save</mat-icon>
        <mat-checkbox class="task-checkbox" [(ngModel)]="task.completed" (change)="toggleCompleted(task)">
        </mat-checkbox>
        <mat-card-title class="task-title">{{ task.title }}</mat-card-title>
      </div>
    </mat-card-header>

    <mat-card-content>
      <p class="task-description">{{ task.description }}</p>
      <mat-list>
        <mat-list-item class="task-detail">
          <mat-icon>calendar_today</mat-icon>
          <strong>Data de criação:</strong>
          <span>{{ task.created_at | date: 'dd/MM/yyyy' }}</span>
        </mat-list-item>
        <mat-divider></mat-divider>
        <mat-list-item class="task-detail">
          <mat-icon>event</mat-icon>
          <strong>Previsão de entrega:</strong>
          <span>{{ task.due_date | date: 'dd/MM/yyyy' }}</span>
        </mat-list-item>
        <mat-divider></mat-divider>
        <mat-list-item class="task-detail">
          <mat-icon>check_circle</mat-icon>
          <strong>Concluída:</strong>
          <span>{{ task.completed ? 'Sim' : 'Não' }}</span>
        </mat-list-item>
        <mat-divider></mat-divider>
        <mat-list-item class="task-detail">
          <mat-icon>priority_high</mat-icon>
          <strong>Prioridade:</strong>
          <span>{{ task.priority }}</span>
        </mat-list-item>
        <mat-divider></mat-divider>
        <mat-list-item class="task-detail">
          <mat-icon>person</mat-icon>
          <strong>ID do Usuário:</strong>
          <span>{{ task.user_id }}</span>
        </mat-list-item>
      </mat-list>
    </mat-card-content>

    <mat-card-footer>
      <div class="task-actions">
        <button mat-icon-button (click)="openEditTaskDialog(task)">
          <mat-icon>edit</mat-icon>
        </button>
        <button mat-icon-button (click)="deleteTask(task.user_id, task.task_id)">
          <mat-icon>delete</mat-icon>
        </button>
        <button mat-icon-button [matMenuTriggerFor]="shareMenu">
          <mat-icon>share</mat-icon>
        </button>
        <mat-menu #shareMenu="matMenu">
          <button mat-menu-item (click)="shareTaskViaWhatsApp(task)">
            <mat-icon>whatsapp</mat-icon>
            WhatsApp
          </button>
          <button mat-menu-item (click)="shareTaskViaEmail(task)">
            <mat-icon>email</mat-icon>
            Email
          </button>
        </mat-menu>
      </div>
    </mat-card-footer>
  </mat-card>
</div>

<ng-template #phoneNumberDialog>
  <h2 mat-dialog-title>
    <mat-icon>share</mat-icon>
    Compartilhar via WhatsApp
  </h2>
  <mat-dialog-content>
    <form [formGroup]="phoneForm">
      <mat-form-field appearance="fill">
        <mat-label>Número de Telefone</mat-label>
        <mat-icon matPrefix>phone</mat-icon>
        <input matInput formControlName="phoneNumber" placeholder="+5511999999999">
        <mat-error *ngIf="phoneForm?.get('phoneNumber')?.hasError('required')">
          O número de telefone é obrigatório
        </mat-error>
        <mat-error *ngIf="phoneForm?.get('phoneNumber')?.hasError('pattern')">
          Formato de número inválido
        </mat-error>
      </mat-form-field>
    </form>
  </mat-dialog-content>
  <mat-dialog-actions align="end">
    <button mat-button (click)="onCancel()">Cancelar</button>
    <button mat-button color="primary" (click)="onShare()">Compartilhar</button>
  </mat-dialog-actions>
</ng-template>